{
  "openapi" : "3.0.1",
  "info" : {
    "title" : "Attachment Storage Service",
    "description" : "Service for storing data objects",
    "version" : "1.0.0"
  },
  "components" : {
    "securitySchemes" : {
      "bearerAuth" : {
        "type" : "http",
        "scheme" : "bearer",
        "description" : "Token issued by IAM"
      }
    },
    "schemas" : {
      "MessageId" : {
        "type" : "integer"
      },
      "BatchDeleteRequest" : {
        "type" : "object",
        "properties" : {
          "conditions" : {
            "type" : "array",
            "minLength" : 1,
            "items" : {
              "type" : "object",
              "properties" : {
                "key" : {
                  "description" : "One of metadata keys",
                  "type" : "string"
                },
                "value" : {
                  "type" : "string"
                }
              }
            }
          }
        }
      },
      "BatchDeleteResponse": {
        "type" : "object",
        "properties" : {
          "id" : {
            "type" : "string"
          },
          "status" : {
            "type" : "string",
            "enum" : [ "started", "running", "completed" ]
          }
        }
      }
    },
    "parameters" : {
      "MessageId" : {
        "name" : "id",
        "description" : "Message identifier",
        "in" : "path",
        "required" : true,
        "schema" : {
          "$ref" : "#/components/schemas/MessageId"
        }
      }
    },
    "examples" : {
      "json" : {
        "summary" : "json object",
        "value" : "{ \"some\": \"json\" }"
      },
      "xml" : {
        "summary" : "xml object",
        "value" : "<xml>some</xml>"
      },
      "text" : {
        "summary" : "plain text object",
        "value" : "plain text"
      },
      "csv" : {
        "summary" : "csv object",
        "value" : "c,s,v"
      },
      "tsv" : {
        "summary" : "tsv object",
        "value" : "t\t\ts\tv"
      },
      "binary" : {
        "summary" : "binary object",
        "value" : "BINARY DATA"
      }
    },
    "requestBodies" : {
      "Message" : {
        "required" : true,
        "content" : {
          "application/json" : {
            "schema" : {
              "type" : "object"
            },
            "example" : {
              "$ref" : "#/components/examples/json/value"
            }
          },
          "application/xml" : {
            "example" : {
              "$ref" : "#/components/examples/xml/value"
            }
          },
          "text/plain" : {
            "example" : {
              "$ref" : "#/components/examples/text/value"
            }
          },
          "text/csv" : {
            "example" : {
              "$ref" : "#/components/examples/csv/value"
            }
          },
          "text/tsv" : {
            "example" : {
              "$ref" : "#/components/examples/tsv/value"
            }
          },
          "application/octet-stream" : {
            "example" : {
              "$ref" : "#/components/examples/binary/value"
            }
          }
        }
      }
    },
    "responses" : {
      "MessageNotFound" : {
        "description" : "Message not found"
      },
      "TooManyMessageRequests" : {
        "description" : "Too many requests"
      },
      "MessageTooLarge" : {
        "description" : "Object is too large"
      }
    },
    "headers" : {
      "MessageLength" : {
        "description" : "Message length in bytes",
        "schema" : {
          "type" : "integer"
        }
      }
    }
  },
  "security" : [ {
    "bearerAuth" : [ ]
  } ],
  "paths" : {
    "/objects/{id}" : {
      "get" : {
        "summary" : "Get object by id",
        "description" : "Returns one object",
        "parameters" : [ {
          "$ref" : "#/components/parameters/MessageId"
        }],
        "responses" : {
          "200" : {
            "headers" : {
              "Content-Length" : {
                "$ref" : "#/components/headers/MessageLength"
              }
            },
            "description" : "Successfully got an object",
            "content" : {
              "application/json" : {
                "schema" : {
                  "type" : "object"
                },
                "example" : {
                  "$ref" : "#/components/examples/json/value"
                }
              },
              "application/xml" : {
                "example" : {
                  "$ref" : "#/components/examples/xml/value"
                }
              },
              "text/plain" : {
                "example" : {
                  "$ref" : "#/components/examples/text/value"
                }
              },
              "text/csv" : {
                "example" : {
                  "$ref" : "#/components/examples/csv/value"
                }
              },
              "text/tsv" : {
                "example" : {
                  "$ref" : "#/components/examples/tsv/value"
                }
              },
              "application/octet-stream" : {
                "example" : {
                  "$ref" : "#/components/examples/binary/value"
                }
              }
            }
          },
          "404" : {
            "$ref" : "#/components/responses/MessageNotFound"
          },
          "429" : {
            "$ref" : "#/components/responses/TooManyMessageRequests"
          }
        }
      },
      "put" : {
        "summary" : "Create an object",
        "description" : "Creates an object with user-generated id",
        "parameters" : [ {
          "$ref" : "#/components/parameters/MessageId"
        }],
        "requestBody" : {
          "$ref" : "#/components/requestBodies/Message"
        },
        "responses" : {
          "201" : {
            "description" : "Successfully created an object"
          },
          "404" : {
            "$ref" : "#/components/responses/MessageNotFound"
          },
          "429" : {
            "$ref" : "#/components/responses/TooManyMessageRequests"
          },
          "409" : {
            "description" : "Object already exists"
          },
          "415" : {
            "description" : "Object type not supported or missing"
          },
          "413" : {
            "$ref" : "#/components/responses/MessageTooLarge"
          }
        }
      },
      "delete" : {
        "summary" : "Delete an object",
        "description" : "Delete entire object",
        "parameters" : [ {
          "$ref" : "#/components/parameters/MessageId"
        }],
        "responses" : {
          "204" : {
            "description" : "Successfully deleted an object"
          },
          "404" : {
            "$ref" : "#/components/responses/MessageNotFound"
          },
          "429" : {
            "$ref" : "#/components/responses/TooManyMessageRequests"
          }
        }
      }
    },
    "/batch/delete" : {
      "post" : {
        "summary" : "Create request for object batch deletion",
        "description" : "Batch deletion is an async process, so we need to start and wait",
        "requestBody" : {
          "required" : true,
          "content" : {
            "application/json" : {
              "schema" : {
                "$ref" : "#/components/schemas/BatchDeleteRequest"
              }
            }
          }
        },
        "responses" : {
          "202" : {
            "description" : "Query started",
            "content" : {
              "application/json" : {
                "schema" : {
                  "$ref" : "#/components/schemas/BatchDeleteResponse"
                }
              }
            }
          }
        }
      }
    },
    "/batch/delete/{id}" : {
      "get" : {
        "summary" : "Get batch delete request status",
        "parameters" : [ {
          "name" : "id",
          "required" : true,
          "description" : "Query id",
          "in" : "path",
          "schema" : {
            "type" : "integer"
          }
        } ],
        "responses" : {
          "200" : {
            "description" : "Query found",
            "content" : {
              "application/json" : {
                "schema" : {
                  "$ref" : "#/components/schemas/BatchDeleteResponse"
                }
              }
            }
          },
          "404" : {
            "description" : "Query not found"
          }
        }
      }
    }
  }
}
